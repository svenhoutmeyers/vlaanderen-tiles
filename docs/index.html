<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Vlaanderen PMTiles Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
      #map{height:90vh;margin:0}
      .prop-popup table{border-collapse:collapse;font:14px/1.35 system-ui,Arial,sans-serif}
      .prop-popup th{padding:4px 8px;text-align:left;vertical-align:top;white-space:nowrap;border-right:1px solid #ddd}
      .prop-popup td{padding:4px 8px;max-width:260px;overflow-wrap:anywhere}
    </style>
  </head>
  <body>
    <div>v0.3</div>
    <div id="map"></div>
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>
    <script>
      const protocol = new pmtiles.Protocol();
      maplibregl.addProtocol("pmtiles", protocol.tile);
    
      const url = "pmtiles://https://svenhoutmeyers.github.io/vlaanderen-tiles/vlaanderen.pmtiles";
    
      const map = new maplibregl.Map({
        container: "map",
        style: {
          version: 8,
          sources: { vlaanderen: { type: "vector", url } },
          layers: [
            { id: "vl-fill", type: "fill", source: "vlaanderen", "source-layer": "sectors", paint: { "fill-opacity": 0.2 } },
            { id: "vl-line", type: "line", source: "vlaanderen", "source-layer": "sectors", paint: { "line-width": 0.6 } }
          ]
        },
        center: [4.5, 51.0], zoom: 7
      });
    
      map.addControl(new maplibregl.NavigationControl(), "top-right");
    
      function esc(s) {
        return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      }
      function propsToHTML(props) {
        const entries = Object.entries(props)
          .filter(([k,v]) => v !== null && v !== undefined && String(v) !== "")
          .sort(([a],[b]) => a.localeCompare(b));
        const rows = entries.map(([k,v]) => `<tr><th>${esc(k)}</th><td>${esc(v)}</td></tr>`).join("");
        return `<div class="prop-popup"><table>${rows || "<tr><td>(geen eigenschappen)</td></tr>"}</table></div>`;
      }
    
      const popup = new maplibregl.Popup({
        closeButton: false,
        closeOnClick: false,
        offset: [8, 8],
        anchor: "top-left",
        maxWidth: "360px"
      });
    
      let hoveredId = null;
    
      map.on("load", () => {
        map.addLayer({
          id: "vl-hover-outline",
          type: "line",
          source: "vlaanderen",
          "source-layer": "sectors",
          paint: {
            "line-width": [
              "case",
              ["boolean", ["feature-state", "hover"], false],
              3,
              0.6
            ]
          }
        }, "vl-line");
    
        map.on("mousemove", "vl-fill", (e) => {
          const f = e.features && e.features[0];
          if (!f) return;
    
          // Popup met alle properties
          popup.setLngLat(e.lngLat)
               .setHTML(propsToHTML(f.properties))
               .addTo(map);
          map.getCanvas().style.cursor = "pointer";
    
          // Hover highlight
          if (hoveredId !== null) {
            map.setFeatureState(
              { source: "vlaanderen", sourceLayer: "sectors", id: hoveredId },
              { hover: false }
            );
          }
          hoveredId = f.id; // vereist --generate-ids
          map.setFeatureState(
            { source: "vlaanderen", sourceLayer: "sectors", id: hoveredId },
            { hover: true }
          );
        });
    
        map.on("mouseleave", "vl-fill", () => {
          popup.remove();
          map.getCanvas().style.cursor = "";
          if (hoveredId !== null) {
            map.setFeatureState(
              { source: "vlaanderen", sourceLayer: "sectors", id: hoveredId },
              { hover: false }
            );
          }
          hoveredId = null;
        });
      }); // <-- deze was je kwijt
    </script>
    

  </body>
</html>
