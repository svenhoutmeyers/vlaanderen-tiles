<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Vlaanderen PMTiles Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
    <style>#map{height:90vh;margin:0}</style>
  </head>
  <body>
    <div>v0.1</div>
    <div id="map"></div>
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>
    <script>
      const protocol = new pmtiles.Protocol();
      maplibregl.addProtocol("pmtiles", protocol.tile);

      // === Gebruik je Pages- of jsDelivr-URL ===
      const url = "pmtiles://https://svenhoutmeyers.github.io/vlaanderen-tiles/vlaanderen.pmtiles";

      const map = new maplibregl.Map({
        container: "map",
        style: {
          version: 8,
          sources: { vlaanderen: { type: "vector", url } },
          layers: [
            { id: "vl-fill", type: "fill", source: "vlaanderen", "source-layer": "sectors", paint: { "fill-opacity": 0.2 } },
            { id: "vl-line", type: "line", source: "vlaanderen", "source-layer": "sectors", paint: { "line-width": 0.6 } }
          ]
        },
        center: [4.5, 51.0], zoom: 7
      });

      map.addControl(new maplibregl.NavigationControl(), "top-right");

      // simpele HTML-escaper
      function esc(s) {
        return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      }

      // properties -> HTML-tabel (gesorteerd op key, lege/null waardes weglaten)
      function propsToHTML(props) {
        const entries = Object.entries(props)
          .filter(([k,v]) => v !== null && v !== undefined && String(v) !== "")
          .sort(([a],[b]) => a.localeCompare(b));
        const rows = entries.map(([k,v]) => `<tr><th>${esc(k)}</th><td>${esc(v)}</td></tr>`).join("");
        return `<div class="prop-popup"><table>${rows || "<tr><td>(geen eigenschappen)</td></tr>"}</table></div>`;
      }

      const popup = new maplibregl.Popup({
        closeButton: false,
        closeOnClick: false,
        offset: [8, 8],
        anchor: "top-left",
        maxWidth: "360px"
      });

      map.on("load", () => {
        // Hover: toon alle metadata in popup
        map.on("mousemove", "vl-fill", (e) => {
          const f = e.features && e.features[0];
          if (!f) return;
          popup.setLngLat(e.lngLat).setHTML(propsToHTML(f.properties)).addTo(map);
          map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "vl-fill", () => {
          popup.remove();
          map.getCanvas().style.cursor = "";
        });

        // Handig om 1x te inspecteren wat er precies in zit:
        // map.on("click", "vl-fill", (e) => console.log(e.features[0].properties));
      });
    </script>

  </body>
</html>
